import requests
import csv
import os

def get_okta_apps(api_token, org_url, output_csv="okta_apps.csv"):
    """
    Retrieves Okta applications and writes them to a CSV file.

    Args:
        api_token (str): Your Okta API token.
        org_url (str): Your Okta organization URL (e.g., "https://your-org.okta.com").
        output_csv (str): The name of the output CSV file.
    """

    headers = {
        "Authorization": f"SSWS {api_token}",
        "Accept": "application/json",
        "Content-Type": "application/json",
    }
    url = f"{org_url}/api/v1/apps"

    try:
        with open(output_csv, "w", newline="", encoding="utf-8") as csvfile:
            writer = csv.writer(csvfile)
            writer.writerow(["ID", "Name", "Label", "Status", "SignOnMode"])  # Header row

            while url:
                response = requests.get(url, headers=headers)
                response.raise_for_status()  # Raise HTTPError for bad responses (4xx or 5xx)

                apps = response.json()

                for app in apps:
                    writer.writerow(
                        [
                            app.get("id", ""),
                            app.get("name", ""),
                            app.get("label", ""),
                            app.get("status", ""),
                            app.get("signOnMode", ""),
                        ]
                    )

                # Check for pagination
                link_header = response.headers.get("Link")
                if link_header:
                    links = link_header.split(",")
                    next_url = None
                    for link in links:
                        if "rel=\"next\"" in link:
                            next_url = link.split(";")[0].strip("<>").strip()
                            url = next_url
                            break
                    if next_url is None:
                        url = None #no more next url, exit loop
                else:
                    url = None #no link header, exit loop

        print(f"Okta applications written to {output_csv}")

    except requests.exceptions.RequestException as e:
        print(f"Error fetching Okta apps: {e}")
    except IOError as e:
        print(f"Error writing to CSV: {e}")
    except ValueError as e:
        print(f"Error parsing JSON: {e}")
    except Exception as e:
        print(f"An unexpected error occurred: {e}")

if __name__ == "__main__":
    # Retrieve API token and org URL from environment variables or user input.
    api_token = os.environ.get("OKTA_API_TOKEN")
    org_url = os.environ.get("OKTA_ORG_URL")

    if not api_token or not org_url:
        print("Please set the OKTA_API_TOKEN and OKTA_ORG_URL environment variables.")
        api_token = input("Enter Okta API Token: ")
        org_url = input("Enter Okta Org URL (e.g., https://your-org.okta.com): ")

    get_okta_apps(api_token, org_url)
